name: iOS Build

# åªåœ¨æ‰‹åŠ¨è§¦å‘æˆ–æ‰“ tag æ—¶æž„å»ºï¼ŒèŠ‚çœå…è´¹é¢åº¦
on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release
  push:
    tags:
      - 'v*'  # åªåœ¨ç‰ˆæœ¬æ ‡ç­¾æ—¶è‡ªåŠ¨æž„å»º

jobs:
  build-ios:
    runs-on: macos-latest  # ä½¿ç”¨æœ€æ–°çš„ macOS runner
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'  # ç¼“å­˜ npm ä¾èµ–
    
    - name: Install dependencies
      run: npm ci  # ä½¿ç”¨ ci è€Œä¸æ˜¯ installï¼Œæ›´å¿«
    
    - name: Cache CocoaPods
      uses: actions/cache@v3
      with:
        path: ios/Pods
        key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-pods-
    
    - name: Install CocoaPods dependencies
      run: |
        cd ios
        pod install
    
    - name: Build iOS app
      run: |
        cd ios
        BUILD_TYPE="${{ github.event.inputs.build_type || 'release' }}"
        
        if [ "$BUILD_TYPE" = "debug" ]; then
          CONFIGURATION="Debug"
        else
          CONFIGURATION="Release"
        fi
        
        # æž„å»ºå¹¶æŒ‡å®šè¾“å‡ºç›®å½•
        xcodebuild -workspace LxMusicMobile.xcworkspace \
          -scheme LxMusicMobile \
          -configuration $CONFIGURATION \
          -sdk iphoneos \
          -arch arm64 \
          -derivedDataPath ./build \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          build
        
        # æŸ¥çœ‹ç”Ÿæˆçš„æ–‡ä»¶
        echo "=== Build output structure ==="
        ls -lah ./build/Build/Products/
        
        # æ‰¾åˆ° .app æ–‡ä»¶
        APP_PATH=$(find ./build/Build/Products -name "*.app" -type d | head -n 1)
        echo "Found app at: $APP_PATH"
        
        if [ -n "$APP_PATH" ]; then
          # èŽ·å– .app å¤§å°
          du -sh "$APP_PATH"
          
          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p ./output
          
          # å¤åˆ¶ .app åˆ°è¾“å‡ºç›®å½•
          cp -R "$APP_PATH" ./output/
          
          # å°è¯•åˆ›å»º IPAï¼ˆå³ä½¿æ²¡æœ‰ç­¾åï¼Œä¹Ÿå¯ä»¥æ‰“åŒ…ï¼‰
          cd ./output
          mkdir -p Payload
          cp -R *.app Payload/
          zip -r LxMusicMobile-${CONFIGURATION}.ipa Payload
          rm -rf Payload
          
          echo "=== Output files ==="
          ls -lah
        else
          echo "ERROR: No .app file found!"
          exit 1
        fi
    
    - name: Upload .app artifact
      uses: actions/upload-artifact@v4
      with:
        name: ios-app-${{ github.event.inputs.build_type || 'release' }}
        path: ios/output/*.app
        retention-days: 7
    
    - name: Upload .ipa artifact
      uses: actions/upload-artifact@v4
      with:
        name: ios-ipa-${{ github.event.inputs.build_type || 'release' }}
        path: ios/output/*.ipa
        retention-days: 7
    
    - name: Build summary
      run: |
        echo "### iOS Build Completed! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Build Type: ${{ github.event.inputs.build_type || 'release' }}" >> $GITHUB_STEP_SUMMARY
        echo "- Version: 1.8.0 (72)" >> $GITHUB_STEP_SUMMARY
        echo "- Bundle ID: cn.xcwl.music.mobile" >> $GITHUB_STEP_SUMMARY
        echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
