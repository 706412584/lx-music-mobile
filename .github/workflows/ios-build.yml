name: iOS Build

# åªåœ¨æ‰‹åŠ¨è§¦å‘æˆ–æ‰“ tag æ—¶æž„å»ºï¼ŒèŠ‚çœå…è´¹é¢åº¦
on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release
  push:
    tags:
      - 'v*'  # åªåœ¨ç‰ˆæœ¬æ ‡ç­¾æ—¶è‡ªåŠ¨æž„å»º

jobs:
  build-ios:
    runs-on: macos-latest  # ä½¿ç”¨æœ€æ–°çš„ macOS runner
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'  # ç¼“å­˜ npm ä¾èµ–
    
    - name: Install dependencies
      run: npm ci  # ä½¿ç”¨ ci è€Œä¸æ˜¯ installï¼Œæ›´å¿«
    
    - name: Cache CocoaPods
      uses: actions/cache@v3
      with:
        path: ios/Pods
        key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-pods-
    
    - name: Install CocoaPods dependencies
      run: |
        cd ios
        pod install
    
    - name: Build iOS app
      run: |
        cd ios
        BUILD_TYPE="${{ github.event.inputs.build_type || 'release' }}"
        
        if [ "$BUILD_TYPE" = "debug" ]; then
          # Debug æž„å»ºï¼ˆæ›´å¿«ï¼Œä¸éœ€è¦ç­¾åï¼‰
          xcodebuild -workspace LxMusicMobile.xcworkspace \
            -scheme LxMusicMobile \
            -configuration Debug \
            -sdk iphoneos \
            -arch arm64 \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            build
        else
          # Release æž„å»ºï¼ˆéœ€è¦ç­¾åï¼‰
          xcodebuild -workspace LxMusicMobile.xcworkspace \
            -scheme LxMusicMobile \
            -configuration Release \
            -sdk iphoneos \
            -arch arm64 \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            build
        fi
    
    - name: Upload build artifact
      uses: actions/upload-artifact@v3
      with:
        name: ios-build-${{ github.event.inputs.build_type || 'release' }}
        path: ios/build/
        retention-days: 7  # åªä¿ç•™ 7 å¤©ï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´
    
    - name: Build summary
      run: |
        echo "### iOS Build Completed! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Build Type: ${{ github.event.inputs.build_type || 'release' }}" >> $GITHUB_STEP_SUMMARY
        echo "- Version: 1.8.0 (72)" >> $GITHUB_STEP_SUMMARY
        echo "- Bundle ID: cn.xcwl.music.mobile" >> $GITHUB_STEP_SUMMARY
        echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
