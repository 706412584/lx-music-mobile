name: iOS Build

# åªåœ¨æ‰‹åŠ¨è§¦å‘æˆ–æ‰“ tag æ—¶æž„å»ºï¼ŒèŠ‚çœå…è´¹é¢åº¦
on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release
  push:
    tags:
      - 'v*'  # åªåœ¨ç‰ˆæœ¬æ ‡ç­¾æ—¶è‡ªåŠ¨æž„å»º

jobs:
  build-ios:
    runs-on: macos-latest  # ä½¿ç”¨æœ€æ–°çš„ macOS runner
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'  # ç¼“å­˜ npm ä¾èµ–
    
    - name: Install dependencies
      run: npm ci  # ä½¿ç”¨ ci è€Œä¸æ˜¯ installï¼Œæ›´å¿«
    
    - name: Sync iOS version and app name from package.json
      run: |
        npm run sync-version-ios
        npm run sync-app-name
    
    - name: Cache CocoaPods
      uses: actions/cache@v3
      with:
        path: ios/Pods
        key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock') }}-${{ hashFiles('ios/Podfile') }}
        restore-keys: |
          ${{ runner.os }}-pods-
    
    - name: Install CocoaPods dependencies
      run: |
        cd ios
        # åªåœ¨ç¼“å­˜æœªå‘½ä¸­æ—¶æ‰æ¸…ç†
        if [ ! -d "Pods" ]; then
          echo "Pods not found in cache, installing fresh..."
        fi
        # ç¡®ä¿ç¦ç”¨ Hermesï¼ˆå·²åœ¨ Podfile ä¸­é…ç½®ï¼‰
        pod install
    
    - name: Build iOS app
      run: |
        cd ios
        BUILD_TYPE="${{ github.event.inputs.build_type || 'release' }}"
        
        if [ "$BUILD_TYPE" = "debug" ]; then
          CONFIGURATION="Debug"
        else
          CONFIGURATION="Release"
        fi
        
        # CI çŽ¯å¢ƒä¸‹éœ€è¦æ‰“åŒ… JS bundleï¼ˆæ²¡æœ‰å¼€å‘æœåŠ¡å™¨ï¼‰
        echo "=== Building JavaScript bundle ==="
        cd ..
        
        if [ "$BUILD_TYPE" = "debug" ]; then
          # Debug æ¨¡å¼ï¼šåŒ…å« source mapï¼Œæ–¹ä¾¿è°ƒè¯•
          npx react-native bundle \
            --platform ios \
            --dev true \
            --entry-file index.js \
            --bundle-output ios/main.jsbundle \
            --assets-dest ios \
            --sourcemap-output ios/main.jsbundle.map
        else
          # Release æ¨¡å¼ï¼šä¼˜åŒ–åŽ‹ç¼©
          npx react-native bundle \
            --platform ios \
            --dev false \
            --entry-file index.js \
            --bundle-output ios/main.jsbundle \
            --assets-dest ios
        fi
        
        echo "JS bundle created:"
        ls -lh ios/main.jsbundle
        cd ios
        
        # æž„å»ºå¹¶æŒ‡å®šè¾“å‡ºç›®å½•
        xcodebuild -workspace LxMusicMobile.xcworkspace \
          -scheme LxMusicMobile \
          -configuration $CONFIGURATION \
          -sdk iphoneos \
          -arch arm64 \
          -derivedDataPath ./build \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          ONLY_ACTIVE_ARCH=NO \
          IPHONEOS_DEPLOYMENT_TARGET=13.4 \
          CLANG_CXX_LANGUAGE_STANDARD=c++17 \
          CLANG_CXX_LIBRARY=libc++ \
          build | tee build.log
        
        # æ£€æŸ¥æž„å»ºæ˜¯å¦æˆåŠŸ
        if [ ${PIPESTATUS[0]} -ne 0 ]; then
          echo "Build failed!"
          exit 1
        fi
        
        # æŸ¥çœ‹ç”Ÿæˆçš„æ–‡ä»¶
        echo "=== Build output structure ==="
        ls -lah ./build/Build/Products/
        
        # æ‰¾åˆ° .app æ–‡ä»¶
        APP_PATH=$(find ./build/Build/Products -name "*.app" -type d | head -n 1)
        echo "Found app at: $APP_PATH"
        
        if [ -n "$APP_PATH" ]; then
          # èŽ·å– .app å¤§å°
          du -sh "$APP_PATH"
          
          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p ./output
          
          # å¤åˆ¶ .app åˆ°è¾“å‡ºç›®å½•
          cp -R "$APP_PATH" ./output/
          
          # å°è¯•åˆ›å»º IPAï¼ˆå³ä½¿æ²¡æœ‰ç­¾åï¼Œä¹Ÿå¯ä»¥æ‰“åŒ…ï¼‰
          cd ./output
          mkdir -p Payload
          cp -R *.app Payload/
          zip -r LxMusicMobile-${CONFIGURATION}.ipa Payload
          rm -rf Payload
          
          echo "=== Output files ==="
          ls -lah
        else
          echo "ERROR: No .app file found!"
          exit 1
        fi
    
    - name: Upload .app artifact
      uses: actions/upload-artifact@v4
      with:
        name: ios-app-${{ github.event.inputs.build_type || 'release' }}
        path: ios/output/*.app
        retention-days: 7
    
    - name: Upload .ipa artifact
      uses: actions/upload-artifact@v4
      with:
        name: ios-ipa-${{ github.event.inputs.build_type || 'release' }}
        path: ios/output/*.ipa
        retention-days: 7
    
    - name: Build summary
      run: |
        VERSION=$(node -p "require('./package.json').version")
        VERSION_CODE=$(node -p "require('./package.json').versionCode")
        echo "### iOS Build Completed! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Build Type: ${{ github.event.inputs.build_type || 'release' }}" >> $GITHUB_STEP_SUMMARY
        echo "- Version: $VERSION ($VERSION_CODE)" >> $GITHUB_STEP_SUMMARY
        echo "- Bundle ID: cn.xcwl.music.mobile" >> $GITHUB_STEP_SUMMARY
        echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
