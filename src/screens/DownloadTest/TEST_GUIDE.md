# 下载功能测试指南

## 概述

本文档提供了测试 LX Music Mobile 下载功能的详细指南。

## 测试环境

- **测试组件**: `src/screens/DownloadTest/index.tsx`
- **核心模块**: `src/core/download/index.ts`
- **状态管理**: `src/store/download/`
- **UI 组件**: `src/screens/Home/Views/Download/index.js`

## 测试用例

### 1. 添加单个下载任务

**目的**: 验证能否成功添加一个下载任务

**步骤**:
1. 点击"测试1: 添加单个下载"按钮
2. 观察测试结果区域

**预期结果**:
- ✓ 显示"成功添加下载任务"
- 当前任务数增加 1
- 下载列表中出现新任务

**验证点**:
- 任务 ID 生成正确
- 初始状态为 "waiting"
- 元数据包含完整的音乐信息

### 2. 添加多个下载任务

**目的**: 验证批量添加下载任务的功能

**步骤**:
1. 点击"测试2: 添加多个下载"按钮
2. 观察任务列表变化

**预期结果**:
- ✓ 显示"成功添加 N 个下载任务"
- 所有任务都出现在列表中
- 每个任务都有唯一的 ID

**验证点**:
- 任务不会重复
- 任务顺序正确
- 状态初始化正确

### 3. 暂停下载任务

**目的**: 验证暂停功能是否正常工作

**前提条件**: 至少有一个正在运行的下载任务

**步骤**:
1. 确保有正在运行的任务
2. 点击"测试3: 暂停下载"按钮
3. 观察任务状态变化

**预期结果**:
- ✓ 显示"成功暂停任务"
- 任务状态变为 "pause"
- 下载进度停止更新

**验证点**:
- 下载线程正确停止
- 状态更新及时
- 已下载的数据保留

### 4. 恢复下载任务

**目的**: 验证恢复暂停任务的功能

**前提条件**: 至少有一个已暂停的任务

**步骤**:
1. 确保有已暂停的任务
2. 点击"测试4: 恢复下载"按钮
3. 观察任务状态变化

**预期结果**:
- ✓ 显示"成功恢复任务"
- 任务状态变为 "run"
- 下载进度继续更新

**验证点**:
- 从上次位置继续下载
- 进度计算正确
- 速度显示正常

### 5. 删除下载任务

**目的**: 验证删除任务功能

**前提条件**: 至少有一个下载任务

**步骤**:
1. 确保列表中有任务
2. 点击"测试5: 删除任务"按钮
3. 观察列表变化

**预期结果**:
- ✓ 显示"成功删除任务"
- 任务从列表中移除
- 如果任务正在运行，下载停止

**验证点**:
- 任务完全移除
- 下载线程正确清理
- 列表更新正确

### 6. 清除已完成任务

**目的**: 验证批量清除已完成任务的功能

**前提条件**: 至少有一个已完成的任务

**步骤**:
1. 等待至少一个任务完成
2. 点击"测试6: 清除已完成"按钮
3. 观察列表变化

**预期结果**:
- ✓ 显示"成功清除 N 个已完成任务"
- 所有已完成任务被移除
- 未完成任务保留

**验证点**:
- 只清除已完成任务
- 正在进行的任务不受影响
- 计数更新正确

### 7. 清空所有任务

**目的**: 验证清空所有任务的功能

**步骤**:
1. 点击"测试7: 清空所有"按钮
2. 确认对话框
3. 观察列表变化

**预期结果**:
- ✓ 显示"成功清空 N 个任务"
- 所有任务被移除
- 正在运行的任务被停止

**验证点**:
- 所有任务完全清除
- 所有下载线程停止
- 状态重置为初始值

## 功能验证清单

### 核心功能
- [ ] 任务创建和初始化
- [ ] 获取音乐下载链接
- [ ] 文件下载和保存
- [ ] 进度跟踪和更新
- [ ] 速度计算和显示

### 状态管理
- [ ] 状态正确转换 (waiting → run → completed/error)
- [ ] 暂停状态处理
- [ ] 错误状态处理
- [ ] 状态持久化

### 队列管理
- [ ] 任务添加
- [ ] 任务删除
- [ ] 任务暂停/恢复
- [ ] 批量操作

### UI 交互
- [ ] 列表显示正确
- [ ] 进度条更新流畅
- [ ] 按钮状态正确
- [ ] 错误提示清晰

### 错误处理
- [ ] 网络错误处理
- [ ] 权限错误处理
- [ ] 文件系统错误处理
- [ ] 链接获取失败处理

## 性能测试

### 并发下载
- 测试同时下载多个任务
- 验证资源使用合理
- 检查是否有内存泄漏

### 大文件下载
- 测试下载大文件（>50MB）
- 验证进度更新准确
- 检查内存使用情况

### 网络切换
- 测试网络中断后恢复
- 验证断点续传功能
- 检查错误恢复机制

## 已知问题

### 需要修复的问题
1. **导入问题**: `src/core/download/index.ts` 中的 nanoid 导入
   - 状态: 已修复
   - 解决方案: 使用 `customAlphabet` 从 nanoid

2. **文件系统 API**: 需要验证所有文件系统调用
   - 状态: 待验证
   - 需要测试: mkdir, existsFile, downloadFile

3. **权限处理**: 需要处理存储权限
   - 状态: 待实现
   - 需要添加权限检查和请求

## 测试注意事项

1. **真实环境测试**: 
   - 需要在真实设备上测试
   - 模拟器可能无法完全模拟文件系统行为

2. **网络环境**:
   - 测试需要稳定的网络连接
   - 建议测试不同网络条件（WiFi, 4G, 弱网）

3. **存储空间**:
   - 确保设备有足够的存储空间
   - 测试存储空间不足的情况

4. **权限**:
   - 确保应用有存储权限
   - 测试权限被拒绝的情况

## 测试报告模板

```
测试日期: YYYY-MM-DD
测试人员: [姓名]
测试设备: [设备型号]
系统版本: [Android/iOS 版本]

测试结果:
- 测试1: [通过/失败] - [备注]
- 测试2: [通过/失败] - [备注]
- 测试3: [通过/失败] - [备注]
- 测试4: [通过/失败] - [备注]
- 测试5: [通过/失败] - [备注]
- 测试6: [通过/失败] - [备注]
- 测试7: [通过/失败] - [备注]

发现的问题:
1. [问题描述]
2. [问题描述]

建议:
1. [改进建议]
2. [改进建议]
```

## 下一步

1. 在真实设备上运行测试组件
2. 执行所有测试用例
3. 记录测试结果
4. 修复发现的问题
5. 重新测试验证修复

## 参考资源

- MusicFree 下载实现: `MusicFree-master/src/pages/downloading/index.tsx`
- React Native FS 文档: https://github.com/itinance/react-native-fs
- 下载类型定义: `src/types/download_list.d.ts`
